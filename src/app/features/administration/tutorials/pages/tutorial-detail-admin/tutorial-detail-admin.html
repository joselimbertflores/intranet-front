<div class="mx-auto max-w-5xl">
  <!-- Header -->
  <div class="mb-8">
    <!-- Volver -->
    <button
      pButton
      icon="pi pi-arrow-left"
      label="Tutoriales"
      class="p-button-text mb-4"
      (click)="goBack()"
    ></button>

    <h1 class="text-3xl font-semibold text-slate-900">
      {{ tutorial.value()?.title }}
    </h1>

    <p class="mt-2 text-slate-600 max-w-3xl">
      {{ tutorial.value()?.summary }}
    </p>

    <div class="flex flex-wrap items-center gap-3 mt-4">
      <p-tag
        [value]="tutorial.value()?.isPublished ? 'Publicado' : 'Borrador'"
        [severity]="tutorial.value()?.isPublished ? 'success' : 'secondary'"
      >
      </p-tag>

      <button
        pButton
        icon="pi pi-pencil"
        label="Editar metadata"
        class="p-button-sm p-button-outlined"
      ></button>

      <button
        *ngIf="tutorial.value()?.isPublished"
        pButton
        icon="pi pi-eye"
        label="Ver pÃºblico"
        class="p-button-sm p-button-text"
      ></button>
    </div>
  </div>

  <div
    cdkDropList
    (cdkDropListDropped)="onDrop($event)"
    class="flex flex-col gap-4"
  >
    @for (block of tutorial.value()?.blocks; track $index) {
      <div
        cdkDrag
        class="group relative bg-surface-0 rounded-xl border border-surface-200 p-5 shadow-sm hover:border-primary-200"
      >
        <div class="flex items-center justify-between mb-3 select-none">
          <div class="flex items-center gap-3">
            <div
              cdkDragHandle
              class="cursor-grab active:cursor-grabbing p-1 text-surface-400 hover:text-surface-600 transition-colors"
            >
              <i class="pi pi-bars text-lg"></i>
            </div>

            <span
              class="text-xs font-bold uppercase tracking-wider text-surface-500 bg-surface-100 px-2 py-1 rounded"
            >
              {{ block.type }}
            </span>
          </div>

          <div
            class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200"
          >
            <button
              pButton
              icon="pi pi-pencil"
              [rounded]="true"
              [text]="true"
              size="small"
              (click)="editBlock(block)"
            ></button>

            <button
              pButton
              icon="pi pi-trash"
              [rounded]="true"
              [text]="true"
              size="small"
              severity="danger"
              (click)="deleteBlock(block)"
            ></button>
          </div>
        </div>

        <div class="pl-2">
          @switch (block.type) {
            @case ("TEXT") {
              <div
                class="prose prose-sm max-w-none text-surface-700"
                [innerHTML]="block.content"
              ></div>
            }

            @case ("IMAGE") {
              <figure class="flex flex-col items-center gap-2">
                <div
                  class="rounded-lg border border-surface-100 overflow-hidden bg-surface-50"
                >
                  <img
                    [src]="block.file?.url"
                    loading="lazy"
                    class="max-h-[350px] w-auto object-contain"
                  />
                </div>
                @if (block.content) {
                  <figcaption class="text-sm text-surface-500 italic">
                    {{ block.content }}
                  </figcaption>
                }
              </figure>
            }

            @case ("VIDEO_URL") {
              <div
                class="aspect-video w-full rounded-lg overflow-hidden border border-surface-100 bg-black"
              >
                <!-- <iframe
            [src]="sanitizeVideoUrl(block.content)"
            class="w-full h-full"
            frameborder="0"
            allowfullscreen
          ></iframe> -->
              </div>
            }

            @case ("VIDEO_FILE") {
              <div class="flex flex-col items-center gap-2">
                <video
                  controls
                  preload="metadata"
                  class="w-full max-h-[350px] rounded-lg border border-surface-100 bg-black"
                >
                  <source [src]="block.file?.url" type="video/mp4" />
                </video>
                @if (block.content) {
                  <p class="text-xs text-surface-500">{{ block.content }}</p>
                }
              </div>
            }

            @case ("FILE") {
              <a
                [href]="block.file?.url"
                target="_blank"
                class="flex items-center gap-3 p-3 border border-surface-200 rounded-lg hover:bg-surface-50 transition-colors"
              >
                <div class="p-2 bg-primary-50 text-primary-600 rounded-full">
                  <i class="pi pi-file"></i>
                </div>
                <span class="text-sm font-medium text-surface-700">
                  {{ block.content || block.file?.originalName }}
                </span>
              </a>
            }
          }
        </div>
      </div>
    }
  </div>
</div>
